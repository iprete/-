<!DOCTYPE html><html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Roulette 기대값 조정기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body { font-family: system-ui, sans-serif; }</style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-3xl mx-auto bg-white shadow rounded-lg overflow-hidden">
    <header class="px-6 py-4 border-b bg-white">
      <h1 class="text-2xl font-bold">Roulette 기대값 조정기</h1>
      <p class="text-gray-600 text-sm">값을 추가·제거하고, 고정 확률 설정, 정규화, 추천/계산 기능을 사용해보세요.</p>
    </header>
    <main class="p-6 space-y-4">
      <div class="flex flex-wrap gap-2">
        <button id="addRow" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">값 추가</button>
        <button id="normBtn" class="px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">정규화</button>
        <button id="suggestBtn" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">추천</button>
        <button id="calcBtn" class="px-3 py-1 bg-indigo-500 text-white rounded hover:bg-indigo-600">계산</button>
      </div>
      <section id="msg" class="text-sm"></section><div class="overflow-x-auto">
    <table id="dataTable" class="w-full text-sm table-auto border-collapse">
      <thead>
        <tr class="bg-gray-200">
          <th class="border px-2 py-1">값</th>
          <th class="border px-2 py-1">확률</th>
          <th class="border px-2 py-1">고정</th>
          <th class="border px-2 py-1">삭제</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="border px-2 py-1"><input type="number" value="0" class="w-20 border rounded p-1 value-cell" readonly/></td>
          <td class="border px-2 py-1"><input type="number" step="0.000001" value="0.100000" class="w-24 border rounded p-1 prob-cell"/></td>
          <td class="border px-2 py-1 text-center"><input type="checkbox" class="fixed-cell" checked/></td>
          <td class="border px-2 py-1 text-center"><button class="delRow text-red-500 hover:text-red-700">✕</button></td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="flex gap-4">
    <div>
      <label class="block text-sm font-medium">EV 최소</label>
      <input type="number" id="evLow" value="4.7" step="0.1" class="border rounded p-1 w-24" />
    </div>
    <div>
      <label class="block text-sm font-medium">EV 최대</label>
      <input type="number" id="evHigh" value="5.0" step="0.1" class="border rounded p-1 w-24" />
    </div>
  </div>
  <section id="result" class="hidden">
    <h2 class="text-xl font-semibold mt-4">결과</h2>
    <p id="summary" class="text-sm mb-2"></p>
    <div class="overflow-x-auto max-h-60 overflow-y-auto">
      <table class="w-full text-sm border-collapse">
        <thead>
          <tr class="bg-gray-200"><th class="border px-2 py-1">값</th><th class="border px-2 py-1">확률</th></tr>
        </thead>
        <tbody id="outBody"></tbody>
      </table>
    </div>
  </section>
</main>

  </div>  <script>
    const tbody = document.querySelector('#dataTable tbody');
    document.getElementById('addRow').addEventListener('click', () => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border px-2 py-1"><input type="number" class="w-20 border rounded p-1 value-cell"/></td>
        <td class="border px-2 py-1"><input type="number" step="0.000001" class="w-24 border rounded p-1 prob-cell"/></td>
        <td class="border px-2 py-1 text-center"><input type="checkbox" class="fixed-cell"/></td>
        <td class="border px-2 py-1 text-center"><button class="delRow text-red-500 hover:text-red-700">✕</button></td>
      `;
      tbody.appendChild(tr);
    });
    tbody.addEventListener('click', e => {
      if (e.target.classList.contains('delRow')) e.target.closest('tr').remove();
    });

    function showMsg(text, error=true) {
      const msg = document.getElementById('msg');
      msg.textContent = text;
      msg.style.color = error ? '#cc0000' : '#008800';
    }

    // 정규화: 모든 확률을 합이 1이 되도록 비율 유지
    document.getElementById('normBtn').addEventListener('click', () => {
      showMsg('');
      const rows = [...tbody.querySelectorAll('tr')];
      let sum = 0;
      rows.forEach(tr => {
        const p = parseFloat(tr.querySelector('.prob-cell').value) || 0;
        sum += p;
      });
      if (sum <= 0) { showMsg('합계가 0이거나 잘못되어 정규화할 수 없습니다.'); return; }
      rows.forEach(tr => {
        const cell = tr.querySelector('.prob-cell');
        const val = parseFloat(cell.value) || 0;
        cell.value = (val / sum).toFixed(6);
      });
      showMsg('정규화 완료', false);
    });

    // 지수 분포 계산
    function computeGeometric(vals, p0, evLow, evHigh) {
      let lo = 0.0001, hi = 0.9999, best;
      const len = vals.length;
      for (let i = 0; i < 100; i++) {
        const q = (lo + hi) / 2;
        const a = (1 - p0) * (1 - q) / (1 - Math.pow(q, len));
        let ev = 0;
        vals.forEach((v, i) => ev += a * Math.pow(q, i) * v);
        if (ev < evLow) hi = q;
        else if (ev > evHigh) lo = q;
        else { best = q; break; }
      }
      if (!best) return null;
      const a = (1 - p0) * (1 - best) / (1 - Math.pow(best, len));
      const probs = vals.map((_, i) => a * Math.pow(best, i));
      return { q: best, probs };
    }

    function calculate() {
      showMsg('');
      document.getElementById('result').classList.add('hidden');
      const evLow = parseFloat(document.getElementById('evLow').value);
      const evHigh = parseFloat(document.getElementById('evHigh').value);
      const rows = [...tbody.querySelectorAll('tr')];
      const fixed = [], vars = [];
      rows.forEach(tr => {
        const v = parseFloat(tr.querySelector('.value-cell').value);
        const p = parseFloat(tr.querySelector('.prob-cell').value) || 0;
        const isFixed = tr.querySelector('.fixed-cell').checked;
        if (isFixed) fixed.push({ v, p }); else vars.push(v);
      });
      const pFixedSum = fixed.reduce((s, r) => s + r.p, 0);
      if (pFixedSum > 1) { showMsg('고정 확률 합이 1을 초과합니다.'); return; }
      const p0 = fixed.find(r => r.v === 0)?.p || 0;
      if (vars.length === 0) { showMsg('고정되지 않은 값이 없습니다.', false); return; }
      const geo = computeGeometric(vars, p0, evLow, evHigh);
      if (!geo) { showMsg('추천할 수 있는 분포가 없습니다. EV 범위를 조정하세요.'); return; }
      // 결과 렌더링
      const out = document.getElementById('outBody'); out.innerHTML = '';
      let evSum = 0, pSum = 0;
      fixed.forEach(r => { evSum += r.v * r.p; pSum += r.p; });
      vars.forEach((v, i) => { evSum += v * geo.probs[i]; pSum += geo.probs[i]; });
      const all = [...fixed.map(r => ({ v: r.v, p: r.p })), ...vars.map((v, i) => ({ v, p: geo.probs[i] }))];
      all.sort((a, b) => a.v - b.v).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="border px-2 py-1 text-right">${r.v}</td><td class="border px-2 py-1 text-right">${r.p.toFixed(6)}</td>`;
        out.appendChild(tr);
      });
      document.getElementById('summary').textContent = `q≈${geo.q.toFixed(4)}, Σp≈${pSum.toFixed(4)}, EV≈${evSum.toFixed(4)}`;
      document.getElementById('result').classList.remove('hidden');
    }

    document.getElementById('calcBtn').addEventListener('click', calculate);
    document.getElementById('suggestBtn').addEventListener('click', calculate);
  </script></body>
</html>